name: Release (GoReleaser)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no release)'
        required: false
        default: true
        type: boolean

permissions:
  contents: write

jobs:
  # ============================================================
  # STAGE 1: Build grammars per platform
  # ============================================================
  build-grammars-macos:
    strategy:
      matrix:
        include:
          - runner: macos-13
            arch: amd64
          - runner: macos-14
            arch: arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4

      - name: Build grammars
        run: |
          chmod +x scripts/build-grammars.sh
          ./scripts/build-grammars.sh darwin

      - name: Upload grammars
        uses: actions/upload-artifact@v4
        with:
          name: grammars-darwin-${{ matrix.arch }}
          path: grammars/

  build-grammars-linux:
    strategy:
      matrix:
        include:
          - arch: amd64
            cc: gcc
            cxx: g++
          - arch: arm64
            cc: aarch64-linux-gnu-gcc
            cxx: aarch64-linux-gnu-g++
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install cross-compiler
        if: matrix.arch == 'arm64'
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Build grammars
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
        run: |
          chmod +x scripts/build-grammars.sh
          ./scripts/build-grammars.sh linux

      - name: Upload grammars
        uses: actions/upload-artifact@v4
        with:
          name: grammars-linux-${{ matrix.arch }}
          path: grammars/

  build-grammars-windows:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.11.0

      - name: Build grammars
        env:
          CC: "zig cc -target x86_64-windows-gnu"
          CXX: "zig c++ -target x86_64-windows-gnu"
        run: |
          chmod +x scripts/build-grammars.sh
          ./scripts/build-grammars.sh windows

      - name: Upload grammars
        uses: actions/upload-artifact@v4
        with:
          name: grammars-windows-amd64
          path: grammars/

  # ============================================================
  # STAGE 2: Build Go binaries + package
  # ============================================================
  release-darwin:
    needs: [build-grammars-macos]
    strategy:
      matrix:
        include:
          - runner: macos-13
            arch: amd64
          - runner: macos-14
            arch: arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Download grammars
        uses: actions/download-artifact@v4
        with:
          name: grammars-darwin-${{ matrix.arch }}
          path: grammars/

      - name: Build
        env:
          CGO_ENABLED: "1"
        run: go build -trimpath -ldflags="-s -w" -o codemap .

      - name: Create archive
        run: |
          mkdir -p dist/codemap-darwin-${{ matrix.arch }}
          cp codemap dist/codemap-darwin-${{ matrix.arch }}/
          cp -r grammars dist/codemap-darwin-${{ matrix.arch }}/
          cp -r scanner/queries dist/codemap-darwin-${{ matrix.arch }}/
          cp README.md dist/codemap-darwin-${{ matrix.arch }}/ 2>/dev/null || true
          cd dist && tar -czvf codemap-darwin-${{ matrix.arch }}.tar.gz codemap-darwin-${{ matrix.arch }}

      - name: Upload archive
        uses: actions/upload-artifact@v4
        with:
          name: codemap-darwin-${{ matrix.arch }}
          path: dist/codemap-darwin-${{ matrix.arch }}.tar.gz

  release-linux:
    needs: [build-grammars-linux]
    strategy:
      matrix:
        include:
          - arch: amd64
            cc: gcc
          - arch: arm64
            cc: aarch64-linux-gnu-gcc
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install cross-compiler
        if: matrix.arch == 'arm64'
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Download grammars
        uses: actions/download-artifact@v4
        with:
          name: grammars-linux-${{ matrix.arch }}
          path: grammars/

      - name: Build
        env:
          CGO_ENABLED: "1"
          GOOS: linux
          GOARCH: ${{ matrix.arch }}
          CC: ${{ matrix.cc }}
        run: go build -trimpath -ldflags="-s -w" -o codemap .

      - name: Create archive
        run: |
          mkdir -p dist/codemap-linux-${{ matrix.arch }}
          cp codemap dist/codemap-linux-${{ matrix.arch }}/
          cp -r grammars dist/codemap-linux-${{ matrix.arch }}/
          cp -r scanner/queries dist/codemap-linux-${{ matrix.arch }}/
          cp README.md dist/codemap-linux-${{ matrix.arch }}/ 2>/dev/null || true
          cd dist && tar -czvf codemap-linux-${{ matrix.arch }}.tar.gz codemap-linux-${{ matrix.arch }}

      - name: Upload archive
        uses: actions/upload-artifact@v4
        with:
          name: codemap-linux-${{ matrix.arch }}
          path: dist/codemap-linux-${{ matrix.arch }}.tar.gz

  release-windows:
    needs: [build-grammars-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Set up Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.11.0

      - name: Create Zig wrapper
        run: |
          mkdir -p "$HOME/zigcc"
          echo '#!/bin/sh' > "$HOME/zigcc/zcc"
          echo 'zig cc -target x86_64-windows-gnu "$@"' >> "$HOME/zigcc/zcc"
          chmod +x "$HOME/zigcc/zcc"
          echo "$HOME/zigcc" >> "$GITHUB_PATH"

      - name: Download grammars
        uses: actions/download-artifact@v4
        with:
          name: grammars-windows-amd64
          path: grammars/

      - name: Build
        env:
          CGO_ENABLED: "1"
          GOOS: windows
          GOARCH: amd64
          CC: zcc
        run: go build -trimpath -ldflags="-s -w" -o codemap.exe .

      - name: Create archive
        run: |
          mkdir -p dist/codemap-windows-amd64
          cp codemap.exe dist/codemap-windows-amd64/
          cp -r grammars dist/codemap-windows-amd64/
          cp -r scanner/queries dist/codemap-windows-amd64/
          cp README.md dist/codemap-windows-amd64/ 2>/dev/null || true
          cd dist && zip -r codemap-windows-amd64.zip codemap-windows-amd64

      - name: Upload archive
        uses: actions/upload-artifact@v4
        with:
          name: codemap-windows-amd64
          path: dist/codemap-windows-amd64.zip

  # ============================================================
  # STAGE 3: Create GitHub Release + Update Package Managers
  # ============================================================
  publish:
    needs: [release-darwin, release-linux, release-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.dry_run == false)
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: codemap-*

      - name: List artifacts
        run: find artifacts -type f

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
          generate_release_notes: true

  update-homebrew:
    needs: [publish]
    runs-on: ubuntu-latest
    env:
      TAG_NAME: ${{ github.ref_name }}
    steps:
      - name: Wait for release assets
        run: sleep 30

      - name: Get version and hashes
        id: info
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          VERSION="${TAG_NAME#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          # Get Darwin ARM64 tarball hash
          curl -sL "https://github.com/JordanCoin/codemap/releases/download/${TAG_NAME}/codemap-darwin-arm64.tar.gz" -o darwin-arm64.tar.gz
          SHA_ARM64=$(shasum -a 256 darwin-arm64.tar.gz | cut -d' ' -f1)
          echo "sha_arm64=$SHA_ARM64" >> "$GITHUB_OUTPUT"

          # Get Darwin AMD64 tarball hash
          curl -sL "https://github.com/JordanCoin/codemap/releases/download/${TAG_NAME}/codemap-darwin-amd64.tar.gz" -o darwin-amd64.tar.gz
          SHA_AMD64=$(shasum -a 256 darwin-amd64.tar.gz | cut -d' ' -f1)
          echo "sha_amd64=$SHA_AMD64" >> "$GITHUB_OUTPUT"

      - name: Update Homebrew tap
        uses: actions/checkout@v4
        with:
          repository: JordanCoin/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        env:
          VERSION: ${{ steps.info.outputs.version }}
          SHA_ARM64: ${{ steps.info.outputs.sha_arm64 }}
          SHA_AMD64: ${{ steps.info.outputs.sha_amd64 }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          cd homebrew-tap
          cat > codemap.rb << EOF
          class Codemap < Formula
            desc "Generate a brain map of your codebase for LLM context"
            homepage "https://github.com/JordanCoin/codemap"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/JordanCoin/codemap/releases/download/${TAG_NAME}/codemap-darwin-arm64.tar.gz"
                sha256 "${SHA_ARM64}"
              else
                url "https://github.com/JordanCoin/codemap/releases/download/${TAG_NAME}/codemap-darwin-amd64.tar.gz"
                sha256 "${SHA_AMD64}"
              end
            end

            def install
              bin.install "codemap"
              (libexec/"grammars").install Dir["grammars/*"] if Dir.exist?("grammars")
              (libexec/"queries").install Dir["queries/*"] if Dir.exist?("queries")
            end

            def caveats
              <<~EOS
                Tree-sitter grammars installed to:
                  #{libexec}/grammars

                For --deps mode, codemap will find them automatically.
              EOS
            end

            test do
              system "#{bin}/codemap", "--help"
            end
          end
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add codemap.rb
          git commit -m "Update codemap to ${VERSION}"
          git push

  update-scoop:
    needs: [publish]
    runs-on: ubuntu-latest
    steps:
      - name: Wait for release assets
        run: sleep 30

      - name: Get version and hash
        id: info
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          VERSION="${TAG_NAME#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          curl -sL "https://github.com/JordanCoin/codemap/releases/download/${TAG_NAME}/codemap-windows-amd64.zip" -o codemap.zip
          SHA256=$(sha256sum codemap.zip | cut -d' ' -f1)
          echo "sha256=$SHA256" >> "$GITHUB_OUTPUT"

      - name: Update Scoop bucket
        uses: actions/checkout@v4
        with:
          repository: JordanCoin/scoop-codemap
          token: ${{ secrets.SCOOP_TOKEN }}
          path: scoop-bucket

      - name: Update manifest
        env:
          VERSION: ${{ steps.info.outputs.version }}
          SHA256: ${{ steps.info.outputs.sha256 }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          cd scoop-bucket
          cat > codemap.json << EOF
          {
            "version": "${VERSION}",
            "description": "Generate a brain map of your codebase for LLM context",
            "homepage": "https://github.com/JordanCoin/codemap",
            "license": "MIT",
            "architecture": {
              "64bit": {
                "url": "https://github.com/JordanCoin/codemap/releases/download/${TAG_NAME}/codemap-windows-amd64.zip",
                "hash": "${SHA256}"
              }
            },
            "bin": "codemap-windows-amd64\\\\codemap.exe",
            "checkver": "github",
            "autoupdate": {
              "architecture": {
                "64bit": {
                  "url": "https://github.com/JordanCoin/codemap/releases/download/v\$version/codemap-windows-amd64.zip"
                }
              }
            }
          }
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add codemap.json
          git commit -m "Update codemap to ${VERSION}"
          git push
